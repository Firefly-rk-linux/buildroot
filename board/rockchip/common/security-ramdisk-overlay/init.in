#!/bin/sh

# devtmpfs does not get automounted for initramfs
/bin/mount -t devtmpfs devtmpfs /dev
/bin/mount -t proc proc /proc
/bin/mount -t sysfs sysfs /sys
/bin/mount -t tmpfs tmpfs /tmp

exec 0</dev/console
exec 1>/dev/console
exec 2>/dev/console

BLOCK_PATH=/sys/class/block
BLOCK_TYPE_SUPPORTED="
mmcblk
flash"

MSG_OUTPUT=/dev/null
DEBUG() {
	echo $1 > $MSG_OUTPUT
}

check_device_is_supported() {
	TARGET_DEV=NONE
	for i in $BLOCK_TYPE_SUPPORTED
	do
		if [ ! -z "$(echo $(basename $1) | grep $i)" ]; then
			TARGET_DEV=$1
			return 0
		fi
	done
}

DEBUG "--------------------------"
DEBUG "Debug For Security Ramboot"
DEBUG "--------------------------"

# make sure /dev/ has mounted
while [ ! -e /dev/mapper/control -o ! -e /proc/mounts ]
do
	usleep 10000
	echo .
done

# make sure BLOCK has get from dev (sometimes uevent delay to send)
while [ -z "${BLOCK}" ]
do

for dev in ${BLOCK_PATH}/*
do
	check_device_is_supported $dev
	if [ "$TARGET_DEV" != "NONE" ]; then
		PARTNAME=$(cat ${TARGET_DEV}/uevent | grep PARTNAME | sed "s#.*PARTNAME=##")
		if [ "$PARTNAME" == "rootfs" ]; then
			BLOCK=/dev/$(basename $TARGET_DEV)
			break
		fi
	fi
done

done

OFFSET=
# encrypto partition should get size from dev
if [ -z "$OFFSET" ]; then
	OFFSET=$(cat ${TARGET_DEV}/size)
fi

DEBUG "OFFSET is ${OFFSET}"

HASH=
CIPHER=
ENC_EN=

if [ "${ENC_EN}" = "true" ]; then
	/usr/bin/tee-supplicant &
	/usr/bin/keybox_app
	KEY=`cat /tmp/syspw`
	dmsetup create vroot --table "0 ${OFFSET} crypt ${CIPHER} ${KEY} 0 ${BLOCK} 0 1 allow_discards"
	echo None > /tmp/syspw
else
	/usr/sbin/veritysetup --hash-offset=${OFFSET} create vroot ${BLOCK} ${STORGE_DEV}p${BLOCK} ${HASH} > /dev/null 2>&1
fi
mount /dev/mapper/vroot /mnt

LABLE=$(dumpe2fs -h /dev/mapper/vroot | grep name | xargs -n 1 | tail -1)

if [ "$LABLE" != "rootfs" ]; then
	mount -o remount,rw /mnt
	resize2fs /dev/mapper/vroot && tune2fs /dev/mapper/vroot -L rootfs
fi

if [ -e "/mnt/init" ]; then
	INIT=/init
else
	INIT=/sbin/init
fi

# echo "exec busybox switch_root /mnt ${INIT}"
# exec busybox switch_root /mnt ${INIT}
exec /sbin/init "$@"
